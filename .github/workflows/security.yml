name: ğŸ›¡ï¸ Security Scan w Composite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security:
    name: ğŸ›¡ï¸ Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write  # Required for SARIF upload
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better analysis

      - name: ğŸ” Scan for vulnerabilities
        uses: mahi7000/Developer_Vulnerability_Scanner@v1.0.1
        with:
          scan-path: '.'
          output-format: 'sarif'
          fail-on-issues: true  # Set to false for testing
        id: security-scan
        continue-on-error: true  # Continue even if vulnerabilities found

      - name: ğŸ“Š Show scan results
        run: |
          echo "=== Security Scan Results ==="
          echo "Security Score: ${{ steps.security-scan.outputs.security-score || 'N/A' }}"
          echo "Total Issues: ${{ steps.security-scan.outputs.total-issues || 'N/A' }}"
          echo "Critical Issues: ${{ steps.security-scan.outputs.critical-issues || 'N/A' }}"
          
          # Check if SARIF file was created
          if [ -f "dvs-results.sarif" ]; then
            echo "âœ… SARIF report generated successfully"
            echo "ğŸ“Š File size: $(wc -l < dvs-results.sarif) lines"
          else
            echo "âŒ SARIF report not found"
            exit 1
          fi

      - name: ğŸ“„ Upload SARIF results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: dvs-results.sarif
          wait-for-processing: true

      - name: ğŸ› Debug Vulnerability Conversion
        run: |
          echo "=== Checking SARIF Content ==="
          if [ -f "dvs-results.sarif" ]; then
            echo "SARIF file content:"
            cat dvs-results.sarif
            echo "=== Analysis ==="
            if jq -e '.runs[0].results | length > 0' dvs-results.sarif > /dev/null; then
              echo "âœ… SARIF contains $(jq '.runs[0].results | length' dvs-results.sarif) vulnerabilities"
              echo "Sample:"
              jq '.runs[0].results[0]' dvs-results.sarif
            else
              echo "âŒ SARIF contains 0 vulnerabilities (but scanner found 3)"
              echo "Full structure:"
              jq '.' dvs-results.sarif
            fi
          fi

      - name: âš ï¸ Fail if critical vulnerabilities found
        if: steps.security-scan.outputs.critical-issues && steps.security-scan.outputs.critical-issues != '0'
        run: |
          echo "âŒ Critical vulnerabilities found: ${{ steps.security-scan.outputs.critical-issues }}"
          echo "Please review the security findings in the GitHub Security tab."
          exit 1
